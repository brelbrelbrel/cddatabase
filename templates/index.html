{% extends "layout.html" %}

{% block content %}
<div class="stage-banner stage-{{ stage }}">
    <div class="stage-content">
        {% if stage == 'list' %}
        <h2>ğŸ“¸ å‡ºå“ãƒªã‚¹ãƒˆä½œæˆ (CSV Mode)</h2>
        <p>è©³ç´°ã‚’ç¢ºèªã—ã€CSVãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¾ã™ã€‚</p>
        {% elif stage == 'review' %}
        <h2>ğŸ§ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º (Review)</h2>
        <p>ãƒãƒƒãƒãƒ³ã‚°ç²¾åº¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ (ä¿¡é ¼åº¦ < 80)ã€‚</p>
                {% elif stage == 'drafts' %}
                <h2>ğŸ“‚ CSVãƒªã‚¹ãƒˆ (Export)</h2>
                <p>è¿½åŠ æ¸ˆã¿ã®ã‚¢ã‚¤ãƒ†ãƒ ã§ã™ã€‚<a href="{{ url_for('download_csv') }}" class="download-link">ğŸ“¥ CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></p>
                {% else %}
                <h2>ğŸ‘‹ ã‚ˆã†ã“ã</h2>
                <p>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                {% endif %}
    </div>
    {% if count is defined %}
    <div class="stage-count">
        æ®‹ã‚Š <strong>{{ count }}</strong> ä»¶
    </div>
    {% endif %}
</div>

{% if stage == 'drafts' %}
<div class="card">
    <div class="card-header">
        <h3>ğŸ“„ CSV Data ({{ count }} items)</h3>
    </div>
    <div class="card-body" style="overflow-x: auto;">
        {% if csv_rows %}
        <table class="csv-table">
            <thead>
                <tr>
                    <th>Release ID</th>
                    <th>Price</th>
                    <th>Condition</th>
                    <th>Comments</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in csv_rows %}
                <tr>
                    <td><a href="https://www.discogs.com/release/{{ row['release_id'] }}" target="_blank">{{
                            row['release_id'] }}</a></td>
                    <td>${{ row['price'] }}</td>
                    <td><span class="badge">{{ row['media_condition'] }}</span></td>
                    <td class="small-text">{{ row['comments'] }}</td>
                    <td>{{ row['status'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-text">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</div>
{% elif item %}
<div class="card">
    <div class="card-header">
        <div class="item-id">
            <span class="badget">ID: {{ item.id }}</span>
            <span class="status-badge {{ item.listing_status|lower }}">{{ item.listing_status or 'æœªå‡ºå“' }}</span>
        </div>
        <div
            class="match-score score-{{ 'low' if item.ebay_match_score < 50 else 'med' if item.ebay_match_score < 80 else 'high' }}">
            ã‚¹ã‚³ã‚¢: {{ item.ebay_match_score or 0 }}
        </div>
    </div>

    <div class="card-body">
        <div class="info-grid">
            <div class="info-section">
                <h3>ğŸ’¿ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±</h3>
                <div class="info-row">
                    <span class="label">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ</span>
                    <span class="value">{{ item.title.split(' : ')[0] if ' : ' in item.title else item.title }}</span>
                </div>
                <div class="info-row">
                    <span class="label">ã‚¿ã‚¤ãƒˆãƒ«</span>
                    <span class="value">{{ item.title.split(' : ')[1] if ' : ' in item.title else '' }}</span>
                </div>
                <div class="info-row">
                    <span class="label">è¦æ ¼å“ç•ª</span>
                    <span class="value">{{ item.catalog_number }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Discogs ID</span>
                    <span class="value"><a href="https://www.discogs.com/release/{{ item.discogs_id }}"
                            target="_blank">{{ item.discogs_id }}</a></span>
                </div>
                <div class="price-tag primary">${{ item.median_price or '0.00' }}</div>
            </div>

            <div class="info-section ebay-section">
                <h3>ğŸ›’ eBay å¸‚å ´ãƒ‡ãƒ¼ã‚¿</h3>
                <div class="info-row">
                    <span class="label">ç›´è¿‘è½æœ­</span>
                    <span class="value">${{ item.ebay_sold_price }}</span>
                </div>
                <div class="info-row">
                    <span class="label">å¹³å‡ä¾¡æ ¼</span>
                    <span class="value">${{ item.ebay_avg_price }}</span>
                </div>
                <div class="info-row">
                    <span class="label">è²©å£²æ•°</span>
                    <span class="value">{{ item.ebay_sold_count }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card-footer">
        {% if stage == 'review' %}
        <div class="action-buttons">
            <form action="{{ url_for('reject', item_id=item.id) }}" method="post" class="flex-form">
                <button type="submit" class="btn btn-reject">âœ– å´ä¸‹ (Reject)</button>
            </form>
            <form action="{{ url_for('confirm', item_id=item.id) }}" method="post" class="flex-form">
                <button type="submit" class="btn btn-confirm">â­• æ‰¿èª (Confirm)</button>
            </form>
        </div>
        {% endif %}

        {% if stage == 'list' and item.discogs_id %}
        <div class="listing-form-wrapper">
            <form action="{{ url_for('list_discogs', item_id=item.id) }}" method="post" enctype="multipart/form-data"
                class="listing-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>çŠ¶æ…‹ (Condition)</label>
                        <select name="condition">
                            <option value="Mint (M)">Mint (M) - æ–°å“</option>
                            <option value="Near Mint (NM or M-)" selected>Near Mint (NM) - æ–°å“åŒæ§˜</option>
                            <option value="Very Good Plus (VG+)">VG+ - è‰¯å¥½</option>
                            <option value="Very Good (VG)">VG - æ™®é€š</option>
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="missing_obi" name="missing_obi" value="1">
                        <label for="missing_obi" class="warning-text">å¸¯ãªã— (No Obi)</label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label>ğŸ“¸ å†™çœŸ (Photo)</label>
                        <input type="file" name="photo" accept="image/*" capture="environment">
                    </div>
                </div>

                <div class="form-actions">
                    <div class="price-input-group">
                        <span>$</span>
                        <input type="number" step="0.01" name="price" value="{{ item.median_price or '9.99' }}">
                    </div>
                    <button type="submit" class="btn btn-list">ğŸ“„ CSVã«è¿½åŠ  (Add to CSV)</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">ğŸ‰</div>
    <h2>å®Œäº†ï¼</h2>
    <p>ã“ã®ã‚¿ã‚¹ã‚¯ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã™ã¹ã¦å‡¦ç†ã•ã‚Œã¾ã—ãŸã€‚</p>
</div>
{% endif %}
{% endblock %}